name: Tests

on:
  pull_request:
    branches: [ main ]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}

    - name: Install dependencies
      run: bun install

    - name: Run tests with coverage
      continue-on-error: true
      run: bun run test:coverage

    - name: Generate test summary
      run: |
        printf "# Vitest Test Summary\n" > vitest-summary.md
        printf "| Total Suites | Passed Suites | Failed Suites | Pending Suites | Total Tests | Passed Tests | Failed Tests | Pending Tests | Success |\n" >> vitest-summary.md
        printf "|--------------|--------------|---------------|---------------|-------------|--------------|--------------|--------------|--------|\n" >> vitest-summary.md
        jq -r '"| " + (.numTotalTestSuites|tostring) + " | " + (.numPassedTestSuites|tostring) + " | " + (.numFailedTestSuites|tostring) + " | " + (.numPendingTestSuites|tostring) + " | " + (.numTotalTests|tostring) + " | " + (.numPassedTests|tostring) + " | " + (.numFailedTests|tostring) + " | " + (.numPendingTests|tostring) + " | " + (if .success then "✅" else "❌" end) + " |"' tests-report.json >> vitest-summary.md
        
        failed_count=$(jq '[.testResults[].assertionResults[] | select(.status=="failed")] | length' tests-report.json)
        if [ "$failed_count" -gt 0 ]; then
          printf "\n## Failed Tests\n" >> vitest-summary.md
          printf "\n\`\`\`json\n" >> vitest-summary.md
          jq -r '.testResults[].assertionResults[] | select(.status=="failed")' tests-report.json >> vitest-summary.md
          printf "\n\`\`\`\n" >> vitest-summary.md
        fi

    - name: Post test summary to PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const md = fs.readFileSync('vitest-summary.md', 'utf8');
          const pr = context.payload.pull_request?.number;
          if (pr) {
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: md
            });
          }

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7

    - name: Fail if tests failed
      run: |
        if [ $(jq '.numFailedTests' tests-report.json) -gt 0 ]; then
          echo "Tests failed. Failing job.";
          exit 1;
        fi